{% extends "base.html" %} 


{% block header %}
<div class="header header-account-overview light-shadow">
    {% if current_user %}
    <div class="container">
        <div class="row">
            <div class="col-md-6"><h1>Account Overview</h1></div>
        </div>
    </div>
    {% else %}
    <div class="hero">
    </div>
    {% end %}
</div>
{% end %} 

{% block content %}
<div class="content">
    <div class="container" role="main">
        <div class="message"></div>
        {% if current_user %}
        <div class="row">
            <div class="col-md-6">
                <!-- Recent Submissions -->
                
                <h4>Recent Submissions <span class="info-icon" data-toggle="tooltip" data-placement="right" title="Quickly view the five latest submissions.">i</span></h4>
                <div class="recent-submissions" role="tabpanel">
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" role="tablist">
                        <li role="presentation" class="active"><a href="#recent-list" aria-controls="recent-list" role="tab" data-toggle="tab">List</a></li>
                        <li role="presentation"><a href="#recent-map" aria-controls="recent-map" role="tab" data-toggle="tab">Map</a></li>
                    </ul>
                    <!-- Tab panes -->
                    <div class="tab-content">
                        <div role="tabpanel" class="tab-pane active recent-block" id="recent-list">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Submitted On</th>
                                        <th>Submitted By</th>
                                        <th>Survey</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for submission in recent_submissions %}
                                        <tr class="submission-row btn-view-submission" data-id="{{ submission.id }}">
                                            <td>{{ submission.save_time.strftime("%b %d, %Y at %H:%M") }}</td>
                                            <td>{{ submission.submitter_name }}</td>
                                            <td>{{ submission.survey_id }}</td>
                                        </tr>
                                    {% end %}
                                </tbody>
                            </table>
                        </div>
                        <div role="tabpanel" class="tab-pane recent-block recent-map" id="recent-map">
                            <div id="recent-map-container"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <!-- Activity Graph -->
                <h4>Activity Graph <span class="info-icon" data-toggle="tooltip" data-placement="right" title="A plot of submissions over the past 30 days.">i</span></h4>
                <div class="activity-graph">
                    <div class="alert alert-info no-activity-message hide">
                        <em>There has been no submission activity for any survey in the past 30 days.</em>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12">
                <h4>Surveys</h4>
                <table id="surveys" class="table-view display table table-striped table-bordered" width="100%" cellspacing="0">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th># of Submissions</th>
                            <th>Latest Submission</th>
                            <th>Activity</th>
                            <th></th>
                        </tr>
                    </thead>
                </table>
            </div>
        </div>
        {% else %}
        <div class="welcome-box content-padded">
            <h3 class="welcome-title">Dokomo<strong>Data</strong></h3>
            <p class="welcome-blurb">The easiest way to collect and use data for development planning.</p>
            <a class="btn btn-primary btn-large btn-login">Log In or Sign Up</a>
	    <div id="msg"></div>
        </div>
        {% end %}
    </div>
</div>

{% end %}


{% block extra_scripts %}


    {% if current_user %}

    <!-- Templates -->
    <script type="text/template" id="view-data-btn-tpl">
        <a class="btn btn-default btn-xs" href="/view/data/<%= survey_id %>"><span class="glyphicon glyphicon-stats"></span> View Data</a>
    </script>

    <script type="text/template" id="download-data-btn-tpl">
        <div class="btn-group">
            <button class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-expanded="false">
                <span class="glyphicon glyphicon-cloud-download"></span> Download Data <span class="caret"></span>
            </button>
            <ul class="dropdown-menu dropdown-menu-right" role="menu">
		<li><a target="_blank" href="/api/v0/surveys/<%= survey_id %>/submissions?user_id={{ current_user_id }}">JSON</a></li>
                <li><a href="#">CSV (coming soon)</a></li>
                <li><a href="#">KML (maybe someday)</a></li>
            </ul>
        </div>
    </script>

    <script type="text/template" id="manage-btn-tpl">
        <a class="btn btn-secondary btn-xs btn-manage" href="/view/<%= survey_id %>" data-id="<%= survey_id %>">Manage Survey</a>
    </script>



    <script type="text/javascript">
        
        $(function () { 

            // Activity Graph
	    $.getJSON('/api/v0/surveys/activity?user_id={{ current_user_id }}', function(data) {

                var results = data.activity,
                    cats = [], 
                    data = [];

                if (!results.length) {
                    $('.no-activity-message').removeClass('hide');
                    return;
                }

                var sorted = _.sortBy(results, function(result) {
		    return result.date;
                });

                _.each(sorted, function(result) {
                    var the_date = moment(result.date, "YYYY-MM-DD").format('MMM D');
                    data.push(result.num_submissions);
                    cats.push(the_date);
                });


                $('.activity-graph').highcharts({
                    chart: {
                        type: 'line'
                    },
                    title: {
                        text: null
                    },
                    colors: [
                        '#666'
                    ],
                    xAxis: {
                        categories: cats
                    },
                    yAxis: {
                        title: {
                            text: '# of submissions'
                        }
                    },
                    series: [{
                        name: 'Submissions',
                        data: data
                    }],
                    credits: {
                        enabled: false
                    }
                });
            });

        
            // Map
            var map, 
                limit = 5;
	    $.getJSON('/api/v0/submissions?user_id={{ current_user_id }}&limit='+limit, function(data) {
                var submissions = data.submissions;
                if (submissions.length) {
		    // TODO: do we want a grey empty map if no location data?
                    $(document).on("shown.bs.tab", 'a[href="#recent-map"]', function() {
                        if (!map) {
                            map = L.map('recent-map-container', {
                                dragging: true,
                                zoom: 14,
                                attributionControl: false
                            });

                            L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {}).addTo(map);

                            var markers = [];
                            _.each(submissions, function(submission) {
                                var answers = submission.answers,
                                    location = _.find(answers, function(answer) {
				      if ((typeof answer.response === 'object') && answer.response) {
				          return ('lng' in answer.response) && ('lat' in answer.response);
			              }
				      return false;
                                    });
                                if (!location) {
                                    return;
                                }

                                var marker = new L.marker([location.response.lat, location.response.lng], {
                                    riseOnHover: true
                                });
                                marker.options.icon = new L.icon({iconUrl: "/static/img/icons/normal_base.png", iconAnchor: [13, 30]});
                                // marker.bindPopup();
                                marker.on('click', function() {
                                    openSubmissionDetailModal(submission.id);
                                });
                                markers.push(marker);

                            });
                            
                            if (markers.length) {
                                var markers_group = new L.featureGroup(markers);
                                markers_group.addTo(map);
                                map.fitBounds(markers_group.getBounds(), {
                                    padding: [40, 40]
                                });
                            } else {
                                console.log('No submissions include location.');
                            }
                        }
                    });
                }
            });


            // DataTables
            var $surveys = $('#surveys'),
                view_btn_tpl = _.template($("#view-data-btn-tpl").html()),
                manage_btn_tpl = _.template($("#manage-btn-tpl").html()),
                dl_btn_tpl = _.template($("#download-data-btn-tpl").html());

            if ($surveys.length > 0) {
                $('#surveys').dataTable({
                    language: {
                        search: "Search by survey title:"
                    },
                    "lengthMenu": [
                        [20, 50, 100],
                        [20, 50, 100]
                    ],
                    "pagingType": "full_numbers",
                    "order": [
                        [2, 'desc']
                    ],
                    "columnDefs": [
                        {
                            "data": 0,
                            "render": function(data, type, row) {
                                return data;
                            },
                            "targets": 0
                        },
                        {
                            "data": 1,
                            targets: 1,
                        },
                        {
                            "data": 2,
                            "render": function(data, type, row) {
                                if (data) {
                                    var datetime = moment(data);
                                    return datetime.format('MMM D, YYYY');
                                } else {
                                    return '';
                                }
                            },
                            "targets": 2
                        }
                        , {
                            "data": 3,
                            "render": function(data, type, row) {
                                return "..."; // TODO: ask @jmwohl about this.
                            },
                            "targets": 3,
                            "sortable": false
                        }
                        , {
                            "data": 3,
                            "render": function(data, type, row) {
                                // console.log(data);
                                var view = view_btn_tpl({survey_id: data}),
                                    dl = dl_btn_tpl({survey_id: data}),
                                    manage = manage_btn_tpl({survey_id: data});

                                return view + "&nbsp;" + dl + "&nbsp;" + manage;
                            },
                            "targets": 4,
                            "width": '340px',
                            "class": "text-center",
                            "sortable": false
                        }
                    ],
                    "columns": [{
                         "name": "title"
                    }, {
                         "name": "num_submissions"
                    }, {
                         "name": "latest_submission_time"
                    }, {
                         "name": "id"
                    }],
                    "processing": true,
                    "serverSide": true,
		    "ajax": function(data, callback, settings) {
		        $.ajax({
			    // This does not handle searching in the exact way specified by
			    // the DataTables documentation. Instead, it searches in the way
			    // that the API expects (search_term, search_fields).
			    "url": "/api/v0/surveys?user_id={{ current_user_id }}",
			    "data": {
			        draw: data.draw,
				offset: data.start,
				limit: data.length === -1 ? undefined : data.length,
				order_by: data.order.map(function(ord) {
		                    return data.columns[ord.column].name + ':' + ord.dir;
				}).join(','),
				fields: data.columns.map(function(c) {return c.name}).join(','),
				search: data.search.value,
				regex: data.search.regex,
				// TODO: search language???
				search_fields: 'title'
			    },
			    "success": function(json) {
			        var response = {
		                    draw: json.draw,
		                    recordsTotal: json.total_entries,
		                    recordsFiltered: json.filtered_entries,
		                    data: json.surveys.map(function(survey) {
		                          return [
		                            JSON.stringify(survey.title),
		                            survey.num_submissions,
		                            survey.latest_submission_time,
		                            survey.id,
		                        ];
		                    })
				};
				callback(response);
			    }
			});
		    }
                });
            }
        });
    
    </script>

    {% end %}

    {% if message %}
    <script>
        App.message("{{ message }}");
    </script>
    {% end %}

{% end %}


